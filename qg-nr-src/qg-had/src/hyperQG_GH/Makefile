######################################################################
#
#   $Id: Makefile,v 1.12 2008-09-24 07:08:23 carlos Exp $
#   
#   Makefile for hypersemil
#   David Neilsen
#
######################################################################

SHELL = /bin/sh

.IGNORE = 
.SUFFIXES : .F90 .f90

HYPER_DIR = $(HEADDIR)/src/hyper
HYPERGR_DIR = $(HEADDIR)/src/hyperQG_GH

all: libhyperQG_GH

#ifdef HOME_LORENE
#LORENE_OBJECTS = lorene_bbh.o
#endif

ifdef CXX_COMMAND
COOK_OBJECTS = cook_bbh.o
COOK = -DCOOK
endif

OBJECTS = hypertype.o hyperparams.o hyperutil.o \
       compute_psi4.o compute_rhs_analysis.o auxvars.o \
       exact.o exactu.o rhs.o analysis.o idfile.o \
       def_initial.o outer.o charvars.o  \
       $(COOK_OBJECTS)
       #def_initial.o outer.o charvars.o $(LORENE_OBJECTS) \
       $(COOK_OBJECTS)

copy_boundary_file:
	if test ! -h $(HYPER_DIR)/hyperboundary.f90; then\
		ln -s $(HYPERGR_DIR)/boundary.f90 $(HYPER_DIR)/hyperboundary.f90;\
	fi
copy_auxvars_file:
	if test ! -h $(HYPER_DIR)/hyperauxvars.f90; then\
		ln -s $(HYPERGR_DIR)/global_auxvars.f90 $(HYPER_DIR)/hyperauxvars.f90;\
	fi

params: hypertype.o hyperparams.o hyperutil.o copy_boundary_file copy_auxvars_file
	echo "Compiling params"


hypertype.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)
hyperparams.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)
hyperutil.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)
hyperio.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)

.F90.o:
	$(F90_FIXED) $(F90SUFFIX) -c $*.F90
.f90.o:
	$(CPP) $(COOK) $*.f90 $*.f90.$(CPPFORTSUFFIX)
	$(F90_) -c $*.f90.$(CPPFORTSUFFIX)
	mv $*.f90.o $*.o
	rm -f $*.f90.$(CPPFORTSUFFIX)

.cc.o:
	$(CXX_COMMAND) $(CXX_FLAGS) -c $*.cc


EQLIB_FULLNAME = lib$(EQS).a
export EQLIB_FULLNAME

libhyperQG_GH: $(OBJECTS)
	echo "!Do NOT Edit this file...it has been copied here from $(EQDIR)" > junk.f
	cat comp_amr_error.f >> junk.f
	/bin/mv junk.f $(AMRDIR)/comp_amr_error.f
	#
	echo "!Do NOT Edit this file...it has been copied here from $(EQDIR)" > junk.f
	cat grid_ell.f >> junk.f
	/bin/mv junk.f $(AMRDIR)/grid_ell.f
	#
	$(AR) $(EQLIB_FULLNAME) $(OBJECTS)
	mv $(EQLIB_FULLNAME) $(LIBDIR)


clean:
	/bin/rm -f hypertype.F90 hyperparams.F90 hyperutil.F90 hyperio.F90
	/bin/rm -f *.mod *.o *.f90.f ifc*
	cd $(HEADDIR)/sbin && $(MAKE) clean
	/bin/rm -f $(LIBDIR)/$(EQLIB_FULLNAME)
