######################################################################
#
#   $Id: Makefile,v 1.1 2010-07-17 22:09:42 carlos Exp $
#   
#   Makefile for hyperCurvedWave
#   David Neilsen
#
######################################################################

SHELL = /bin/sh

.IGNORE = 
.SUFFIXES : .F90 .f90 .F

all: params libhyperQuadG

HYPER_DIR = $(HEADDIR)/src/hyper
HYPERBSSN_DIR = $(HEADDIR)/src/hyperQuadG
ifdef HOME_LORENE
LORENE_OBJECTS = lorene_magstar.o
endif


OBJECTS = hypertype.o hyperparams.o hyperutil.o \
          exact.o grid_ell.o futil.o f2cutil.o \
          bssnrhs.o constraints.o derivs.o psi4.o \
          enforce_bssn.o adm2bssn.o \
          auxvars.o initial.o charvars.o output.o rhs.o \
          bcs.o analysis.o

copy_boundary_file:
	if test ! -h $(HYPER_DIR)/hyperboundary.f90; then\
		ln -s $(HYPERBSSN_DIR)/boundary.f90 $(HYPER_DIR)/hyperboundary.f90;\
	fi

copy_auxvars_file:
	if test ! -h $(HYPER_DIR)/hyperauxvars.f90; then\
		ln -s $(HYPERBSSN_DIR)/global_auxvars.f90 $(HYPER_DIR)/hyperauxvars.f90;\
	fi

bssn_headers:
	cd include && $(MAKE)

params: hypertype.o hyperparams.o hyperutil.o copy_boundary_file \
        copy_auxvars_file bssn_headers
	echo "Compiling params"

hypertype.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)
hyperparams.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)
hyperutil.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)
hyperio.F90: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)
cpar.c: ./setup $(SETUPSCRIPT)
	cd $(HEADDIR)/sbin && $(MAKE)


.f.o:
	$(F90_FIXED) -c $*.f
.F.o:
	$(F90_FIXED) -c $*.F
.F90.o:
	$(F90_FIXED) $(F90SUFFIX) $(CPPMACRO)$(MACRO) -c $*.F90
.f90.o:
	$(CPP) $*.f90 $*.f90.$(CPPFORTSUFFIX)
	$(F90_) -c $*.f90.$(CPPFORTSUFFIX)
	mv $*.f90.o $*.o
	rm -f $*.f90.$(CPPFORTSUFFIX)
.c.o:
	$(CC_) $(GSL_FLAG) -c $*.c
.cc.o:
	$(CXX_COMMAND) $(CXX_MACRO) $(CXX_FLAGS) -c $*.cc


EQLIB_FULLNAME = lib$(EQS).a
export EQLIB_FULLNAME

libhyperQuadG: $(OBJECTS)
	echo "!Do NOT Edit this file...it has been copied here from $(EQDIR)" > junk.f
	cat comp_amr_error.f >> junk.f
	/bin/mv junk.f $(AMRDIR)/comp_amr_error.f
	#
	echo "!Do NOT Edit this file...it has been copied here from $(EQDIR)" > junk.f
	cat grid_ell.f >> junk.f
	/bin/mv junk.f $(AMRDIR)/grid_ell.f
	#
	$(AR) $(EQLIB_FULLNAME) $(OBJECTS)
	mv $(EQLIB_FULLNAME) $(LIBDIR)
	$(RANLIB) $(RANLIB_FLAGS) $(LIBDIR)/$(EQLIB_FULLNAME)


clean:
	/bin/rm -f hypertype.F90 hyperparams.F90 hyperutil.F90 hyperio.F90 lorene_magstar.cc
	/bin/rm -f *.mod *.o *.stb
	cd include && $(MAKE) clean
	cd $(HEADDIR)/sbin && $(MAKE) clean
	/bin/rm -f $(LIBDIR)/$(EQLIB_FULLNAME)
